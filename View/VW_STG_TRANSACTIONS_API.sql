create or replace view TIGERANALYTICSPOC_CLEANSE.HEVOGIJ_STG.VW_STG_TRANSACTIONS_API(
	TRANSACTIONID,
	ADDONLICENSEID,
	HOSTLICENSEID,
	LICENSEID,
	ADDONKEY,
	ADDONNAME,
	LASTUPDATED,
	PAYMENTSTATUS,
	APPENTITLEMENTID,
	APPENTITLEMENTNUMBER,
	HOSTENTITLEMENTID,
	HOSTENTITLEMENTNUMBER,
	CLOUDID,
	__HEVO_ID,
	CUSTOMERDETAILS_COUNTRY,
	CUSTOMERDETAILS_BILLINGCONTACT_EMAIL,
	CUSTOMERDETAILS_BILLINGCONTACT_NAME,
	CUSTOMERDETAILS_TECHNICALCONTACT_EMAIL,
	CUSTOMERDETAILS_TECHNICALCONTACT_NAME,
	CUSTOMERDETAILS_COMPANY,
	CUSTOMERDETAILS_REGION,
	PURCHASEDETAILS_HOSTING,
	PURCHASEDETAILS_PARENTPRODUCTNAME,
	PURCHASEDETAILS_OLDPARENTPRODUCTEDITION,
	PURCHASEDETAILS_SALETYPE,
	PURCHASEDETAILS_CHANGEINPARENTPRODUCTEDITION,
	PURCHASEDETAILS_SALEDATE,
	PURCHASEDETAILS_PURCHASEPRICE,
	PURCHASEDETAILS_LICENSETYPE,
	PURCHASEDETAILS_MAINTENANCEENDDATE,
	PURCHASEDETAILS_TIER,
	PURCHASEDETAILS_CHANGEINBILLINGPERIOD,
	PURCHASEDETAILS_OLDTIER,
	PURCHASEDETAILS_BILLINGPERIOD,
	PURCHASEDETAILS_VENDORAMOUNT,
	PURCHASEDETAILS_PARENTPRODUCTEDITION,
	PURCHASEDETAILS_CHANGEINTIER,
	PURCHASEDETAILS_MAINTENANCESTARTDATE,
	PURCHASEDETAILS_OLDBILLINGPERIOD,
	PURCHASEDETAILS_PARTNERDISCOUNTAMOUNT,
	PURCHASEDETAILS_DISCOUNTS,
	PARTNERDETAILS_BILLINGCONTACT_EMAIL,
	PARTNERDETAILS_BILLINGCONTACT_NAME,
	PARTNERDETAILS_PARTNERNAME,
	PARTNERDETAILS_PARTNERTYPE,
	DUNNINGSTATUS,
	DUNNINGSTATUS_1_ATTEMPTCOUNT,
	DUNNINGSTATUS_1_ERRORCODE,
	DUNNINGSTATUS_1_PAYMENTATTEMPTDATE,
	DUNNINGSTATUS_1_NEXTPAYMENTATTEMPTDATE,
	DUNNINGSTATUS_2_ATTEMPTCOUNT,
	DUNNINGSTATUS_2_ERRORCODE,
	DUNNINGSTATUS_2_PAYMENTATTEMPTDATE,
	DUNNINGSTATUS_2_NEXTPAYMENTATTEMPTDATE,
	DUNNINGSTATUS_3_ATTEMPTCOUNT,
	DUNNINGSTATUS_3_ERRORCODE,
	DUNNINGSTATUS_3_PAYMENTATTEMPTDATE,
	DUNNINGSTATUS_3_NEXTPAYMENTATTEMPTDATE,
	DUNNINGSTATUS_4_ATTEMPTCOUNT,
	DUNNINGSTATUS_4_ERRORCODE,
	DUNNINGSTATUS_4_PAYMENTATTEMPTDATE,
	DUNNINGSTATUS_4_NEXTPAYMENTATTEMPTDATE,
	DUNNINGSTATUS_5_ATTEMPTCOUNT,
	DUNNINGSTATUS_5_ERRORCODE,
	DUNNINGSTATUS_5_PAYMENTATTEMPTDATE,
	DUNNINGSTATUS_5_NEXTPAYMENTATTEMPTDATE,
	DUNNINGSTATUS_6_ATTEMPTCOUNT,
	DUNNINGSTATUS_6_ERRORCODE,
	DUNNINGSTATUS_6_PAYMENTATTEMPTDATE,
	DUNNINGSTATUS_6_NEXTPAYMENTATTEMPTDATE,
	DUNNINGSTATUS_7_ATTEMPTCOUNT,
	DUNNINGSTATUS_7_ERRORCODE,
	DUNNINGSTATUS_7_PAYMENTATTEMPTDATE,
	DUNNINGSTATUS_7_NEXTPAYMENTATTEMPTDATE,
	PURCHASEDETAILS_CREDITNOTEREASON,
	PURCHASEDETAILS_REFUNDREASON,
	PURCHASEDETAILS_LOYALTYDISCOUNTAMOUNT,
	PURCHASEDETAILS_ORIGINALTRANSACTIONDETAILS_TRANSACTIONID,
	PURCHASEDETAILS_ORIGINALTRANSACTIONDETAILS_SALEDATE,
	__HEVO__INGESTED_AT,
	__HEVO__LOADED_AT,
	PURCHASEDETAILS_PAYMENTTERMS,
	TRANSACTIONLINEITEMID,
	RUN_ID
) as SELECT *
        FROM HEVOGIJ.PUBLIC.TRANSACTIONS_API
        WHERE TRY_TO_TIMESTAMP(__HEVO__INGESTED_AT::VARCHAR)>=(SELECT IFNULL(MAX(WATER_MARK_VAL),'1900-01-01') FROM TIGERANALYTICSPOC_CLEANSE.PROCESS_CONTROL.LOAD_CONTROL_WATERMARK WHERE TARGET_TBL='STG_TRANSACTIONS_API')
        qualify row_number() over (partition by TRANSACTIONID,IFNULL(APPENTITLEMENTNUMBER,LICENSEID) ORDER BY __HEVO__INGESTED_AT DESC,IFNULL(LICENSEID,HOSTENTITLEMENTNUMBER),PURCHASEDETAILS_MAINTENANCEENDDATE,REGEXP_REPLACE(transactionid, '[^0-9]', ''),PURCHASEDETAILS_SALEDATE)=1;
